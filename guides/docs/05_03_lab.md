# 5 -Lab 3 -Events on CDI

In this event lab we will learn how to use DDD events exploring CDI events.

## Step 1: Create the event:

```java
public record ProductPriceChanged(String productId, BigDecimal oldPrice, BigDecimal newPrice) {
}
```

## Create Update Product price domain event:


```java
package com.example.ecommerce.domain;

import com.example.ecommerce.annotations.DomainService;
import com.example.ecommerce.domain.events.ProductPriceChanged;
import jakarta.enterprise.event.Event;
import jakarta.inject.Inject;

import java.math.BigDecimal;
import java.util.Objects;

@DomainService
public class UpdateProductPrice {

    private final ProductRepository repository;

    private final Event<ProductPriceChanged> productPriceChangedEvent;


    @Inject
    public UpdateProductPrice(ProductRepository repository, Event<ProductPriceChanged> productPriceChangedEvent) {
        this.repository = repository;
        this.productPriceChangedEvent = productPriceChangedEvent;
    }

    public void execute(Product product, BigDecimal price) {
        Objects.requireNonNull(product, "Product must not be null.");
        Objects.requireNonNull(price, "Price must not be null.");
        if (price.compareTo(BigDecimal.ZERO) <= 0) {
            throw new IllegalArgumentException("Price must be > 0.");
        }
        var event = new ProductPriceChanged(product.getId(), product.getPrice().amount(), price);
        this.productPriceChangedEvent.fire(event);
        product.update(price);
        this.repository.save(product);
    }
}
```

Update the Application class to call the new UpdateProductPrice service, thus update the class `ProductService`: 

```java
package com.example.ecommerce.domain;

import com.example.ecommerce.annotations.ApplicationService;
import jakarta.inject.Inject;

import java.math.BigDecimal;
import java.util.List;
import java.util.Optional;

@ApplicationService
public class ProductService {

    private final ProductRepository productRepository;

    private final UpdateProductPrice updateProductPrice;

    @Inject
    public ProductService(ProductRepository productRepository, UpdateProductPrice updateProductPrice) {
        this.productRepository = productRepository;
        this.updateProductPrice = updateProductPrice;
    }

    public Product save(Product product) {
        return productRepository.save(product);
    }

    public void delete(String id) {
        productRepository.delete(id);
    }

    public Optional<Product> findById(String id) {
        return productRepository.findById(id);
    }

    public List<Product> findAll() {
        return productRepository.findAll();
    }

    public void changePrice(String id, BigDecimal price) {
        Product product = productRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Product with id " + id + " not found"));
        //we could improve this exception as well.
        this.updateProductPrice.execute(product, price);
    }
}
```